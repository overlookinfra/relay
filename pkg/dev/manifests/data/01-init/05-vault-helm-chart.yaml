apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: vault
  namespace: kube-system
spec:
  chart: vault
  targetNamespace: relay-system
  repo: https://helm.releases.hashicorp.com
  version: 0.9.0
  valuesContent: |
    server:
      extraInitContainers:
      - name: oauthapp
        image: "alpine"
        command: [sh, -c]
        args:
        - cd /tmp &&
          wget https://github.com/puppetlabs/vault-plugin-secrets-oauthapp/releases/download/v1.10.0/vault-plugin-secrets-oauthapp-v1.10.0-linux-amd64.tar.xz &&
          tar -xf vault-plugin-secrets-oauthapp-v1.10.0-linux-amd64.tar.xz &&
          chmod +x vault-plugin-secrets-oauthapp-v1.10.0-linux-amd64 &&
          mv vault-plugin-secrets-oauthapp-v1.10.0-linux-amd64 /usr/local/libexec/vault &&
          wget https://github.com/puppetlabs/vault-plugin-secrets-oauthapp/releases/download/v3.0.0-beta.3/vault-plugin-secrets-oauthapp-v3.0.0-beta.3-linux-amd64.tar.xz &&
          tar -xf vault-plugin-secrets-oauthapp-v3.0.0-beta.3-linux-amd64.tar.xz &&
          chmod +x vault-plugin-secrets-oauthapp-v3.0.0-beta.3-linux-amd64 &&
          mv vault-plugin-secrets-oauthapp-v3.0.0-beta.3-linux-amd64 /usr/local/libexec/vault
        volumeMounts:
        - name: plugins
          mountPath: /usr/local/libexec/vault
      volumes:
      - name: plugins
        emptyDir: {}
      volumeMounts:
      - mountPath: /usr/local/libexec/vault
        name: plugins
        readOnly: true
      standalone:
        config: |
          ui = true

          plugin_directory = "/usr/local/libexec/vault"
          log_level = "Debug"

          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
          }
          storage "file" {
            path = "/vault/data"
          }
